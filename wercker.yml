box: wercker/nodejs
build:
  steps:
    - script:
        name: Clone and compile bootstrap 
        code: |
          git clone https://github.com/twbs/bootstrap.git ${WERCKER_ROOT}/bootstrap
          sudo npm install less -g
          export TIMESTAMP=$(date +"%s" | md5sum|awk '{ print $1 }')
          lessc --clean-css style.less>rg-${TIMESTAMP}.css
          export FILES=$(find . -type f -name "*.css" |sed -E "s/\.\/(.+)/\1/" | awk ' BEGIN { ORS = ""; print "["; } { print "\/\@"$0"\/\@"; } END { print "]"; }' | sed "s^\"^\\\\\"^g;s^\/\@\/\@^\", \"^g;s^\/\@^\"^g")
          curl -d "{\"hash\": \"${TIMESTAMP}\",\"files\": ${FILES} }" -X PUT ${CLOUDANT_URL} -H "Content-Type:application/json"
deploy:
  steps:
    - script:
        name: Deploy to cloudfiles
        code: |
          sudo pip install turbolift
          turbolift -a ${CLOUDFILES_APIKEY} -u ${CLOUDFILES_USERNAME} --os-rax-auth ord upload --sync -s ${WERCKER_ROOT}/rg*.css -c ${CLOUDFILES_CONTAINER}
